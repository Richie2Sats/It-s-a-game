<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ðŸŽ¨ Draw & Guess Party</title>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    body { font-family: Arial; text-align: center; background: linear-gradient(45deg, #ff9a9e, #fad0c4, #fad0c4, #ff9a9e); background-size: 400% 400%; animation: gradientShift 15s ease infinite; color: #333; margin: 0; padding: 20px; min-height: 100vh; }
    @keyframes gradientShift { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    h1 { font-size: 36px; text-shadow: 0 0 20px white; }
    #qr-section { margin: 40px; font-size: 24px; }
    #qr-code { margin: 30px auto; background: white; padding: 20px; border-radius: 20px; display: inline-block; width: 300px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
    #new-game-btn { padding: 15px 30px; font-size: 24px; background: #ff6b6b; color: white; border: none; border-radius: 15px; cursor: pointer; margin: 20px; }
    #canvas-container { display: none; margin: 20px auto; width: 600px; max-width: 90%; background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
    canvas { border-radius: 20px; touch-action: none; }
    #tools { margin: 10px; }
    #tools button { padding: 10px 20px; margin: 5px; background: #4ecdc4; color: white; border: none; border-radius: 10px; cursor: pointer; }
    #chat { height: 200px; overflow-y: scroll; background: rgba(255,255,255,0.8); padding: 10px; border-radius: 15px; margin: 20px auto; width: 90%; max-width: 600px; text-align: left; }
    #chat-input { width: 80%; padding: 10px; font-size: 18px; border-radius: 10px; border: none; }
    #chat-send { padding: 10px 20px; background: #ff6b6b; color: white; border: none; border-radius: 10px; cursor: pointer; }
    #word { font-size: 28px; font-weight: bold; margin: 20px; }
    #status { font-size: 28px; margin: 30px; }
    .correct { color: green; font-weight: bold; animation: bounce 0.5s; }
    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
  </style>
</head>
<body>
  <h1>ðŸŽ¨ Draw & Guess Party Game</h1>
  <button id="new-game-btn" onclick="location.reload()">Start New Game (New QR)</button>
  <div id="qr-section">
    <p>Host: Show this QR to friends!</p>
    <p>Guests: Scan to join and guess!</p>
    <div id="qr-code"></div>
  </div>
  <div id="status">Waiting for players...</div>
  <div id="word"></div>
  <div id="canvas-container">
    <canvas id="canvas" width="600" height="400"></canvas>
    <div id="tools">
      <button onclick="changeColor('black')">Black</button>
      <button onclick="changeColor('red')">Red</button>
      <button onclick="changeColor('blue')">Blue</button>
      <button onclick="changeColor('green')">Green</button>
      <button onclick="clearCanvas()">Clear</button>
    </div>
  </div>
  <div id="chat"></div>
  <input id="chat-input" placeholder="Type guess here..." onkeydown="if(event.keyCode==13) sendGuess()">
  <button id="chat-send" onclick="sendGuess()">Send</button>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDxwj4gjfwCGjgsWCpEHDyB8B03cpGs",
      authDomain: "it-s-a-game-c564d.firebaseapp.com",
      databaseURL: "https://it-s-a-game-c564d-default-rtdb.firebaseio.com/",
      projectId: "it-s-a-game-c564d",
      storageBucket: "it-s-a-game-c564d.appspot.com",
      messagingSenderId: "833723070612",
      appId: "1:833723070612:web:b09c51fc80fa964b9c81",
      measurementId: "G-R21LB7V3KH"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let gameRef, playerId = null, isDrawer = false;
    const roomId = new URLSearchParams(window.location.search).get('room') || Math.random().toString(36).substring(2, 8);
    if (!new URLSearchParams(window.location.search).get('room')) {
      history.replaceState(null, '', '?room=' + roomId);
    }
    gameRef = db.ref('games/' + roomId);

    const words = ['cat', 'dog', 'house', 'car', 'tree', 'sun', 'pizza', 'phone', 'rocket', 'banana'];
    let currentWord = '';

    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let drawing = false;
    let color = 'black';

    canvas.addEventListener('mousedown', startDraw);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDraw);
    canvas.addEventListener('mouseout', stopDraw);
    canvas.addEventListener('touchstart', startDraw);
    canvas.addEventListener('touchmove', draw);
    canvas.addEventListener('touchend', stopDraw);

    function startDraw(e) {
      if (!isDrawer) return;
      drawing = true;
      draw(e);
    }

    function draw(e) {
      if (!drawing || !isDrawer) return;
      ctx.lineWidth = 5;
      ctx.lineCap = 'round';
      ctx.strokeStyle = color;

      let rect = canvas.getBoundingClientRect();
      let x = (e.clientX || e.touches[0].clientX) - rect.left;
      let y = (e.clientY || e.touches[0].clientY) - rect.top;

      ctx.lineTo(x, y);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(x, y);

      // Sync drawing
      gameRef.child('drawing').push({x, y, color});
    }

    function stopDraw() {
      drawing = false;
      ctx.beginPath();
    }

    function changeColor(c) { color = c; }

    function clearCanvas() {
      if (!isDrawer) return;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      gameRef.child('drawing').set(null);
    }

    function confettiBurst() {
      confetti({particleCount: 200, spread: 70, origin: { y: 0.6 }});
    }

    // QR Code
    new QRCode(document.getElementById("qr-code"), {
      text: window.location.href,
      width: 280,
      height: 280
    });

    // Game Logic
    gameRef.child('players').on('value', snap => {
      const players = snap.val() || {};
      const count = Object.keys(players).length;
      if (count === 1) {
        playerId = 'drawer';
        isDrawer = true;
        document.getElementById('status').textContent = 'You are the Drawer! Wait for guessers...';
        document.getElementById('canvas-container').style.display = 'block';
        currentWord = words[Math.floor(Math.random() * words.length)];
        document.getElementById('word').textContent = `Draw: ${currentWord.toUpperCase()}`;
        gameRef.child('word').set(currentWord);
      } else if (count > 1) {
        if (playerId === null) playerId = 'guesser' + count;
        document.getElementById('status').textContent = 'Game in progress! Guess the drawing';
        document.getElementById('canvas-container').style.display = 'block';
        document.getElementById('word').textContent = 'Guess the word!';
      }
      if (count > 10) document.getElementById('status').textContent = 'Room full â€” start new game!';
    });

    gameRef.child('drawing').on('child_added', snap => {
      const point = snap.val();
      ctx.lineWidth = 5;
      ctx.lineCap = 'round';
      ctx.strokeStyle = point.color;
      ctx.lineTo(point.x, point.y);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(point.x, point.y);
    });

    gameRef.child('chat').on('child_added', snap => {
      const msg = snap.val();
      const chat = document.getElementById('chat');
      const div = document.createElement('div');
      div.textContent = msg.player + ': ' + msg.text;
      if (msg.correct) div.className = 'correct';
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
      if (msg.correct) confettiBurst();
    });

    function sendGuess() {
      const input = document.getElementById('chat-input');
      const guess = input.value.trim().toLowerCase();
      if (!guess) return;
      input.value = '';
      gameRef.child('word').once('value', snap => {
        const word = snap.val();
        const correct = guess === word;
        gameRef.child('chat').push({
          player: playerId,
          text: guess,
          correct
        });
        if (correct) {
          document.getElementById('status').textContent = 'Correct! New round starting...';
          setTimeout(() => location.reload(), 3000);
        }
      });
    }

    // Clear old drawing on new round
    gameRef.child('drawing').set(null);
  </script>
</body>
</html>