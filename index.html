<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üö¢ Battleship Battle</title>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    body { font-family: Arial; text-align: center; background: linear-gradient(45deg, #001f3f, #0074D9, #7FDBFF); color: white; margin: 0; padding: 20px; min-height: 100vh; }
    h1 { font-size: 36px; text-shadow: 0 0 20px white; }
    #new-game-btn { padding: 15px 30px; font-size: 24px; background: #ff4136; border: none; border-radius: 15px; cursor: pointer; margin: 20px; }
    #qr-section { margin: 40px; font-size: 24px; }
    #qr-code { margin: 30px auto; background: white; padding: 20px; border-radius: 20px; display: inline-block; width: 300px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    #status { font-size: 28px; margin: 30px; }
    #grids { display: flex; justify-content: center; flex-wrap: wrap; gap: 40px; margin: 20px; }
    .grid { border-collapse: collapse; }
    .grid td { width: 40px; height: 40px; border: 1px solid #aaa; text-align: center; font-size: 20px; cursor: pointer; }
    .grid td.ship { background: #333; }
    .grid td.hit { background: #ff4136; animation: explode 0.5s; }
    .grid td.miss { background: #7FDBFF; }
    .grid td:hover { background: rgba(255,255,255,0.2); }
    @keyframes explode { 0% { transform: scale(1); } 50% { transform: scale(1.5); opacity: 0.5; } 100% { transform: scale(1); } }
    #victory { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.9); padding: 60px; border-radius: 30px; font-size: 48px; color: gold; z-index: 1000; box-shadow: 0 0 60px gold; }
  </style>
</head>
<body>
  <canvas id="confetti-canvas"></canvas>
  <div id="victory">üö¢ YOU SUNK THEIR FLEET! üèÜ<br><button onclick="location.reload()" style="margin-top:40px;padding:20px 40px;font-size:28px;">New Battle</button></div>
  <h1>üö¢ Battleship Battle</h1>
  <button id="new-game-btn" onclick="location.reload()">Start New Battle (New QR)</button>
  <div id="qr-section">
    <p>Host: Show this QR!</p>
    <p>Guest: Scan to join</p>
    <div id="qr-code"></div>
  </div>
  <div id="status">Setting up fleet...</div>
  <div id="grids">
    <div>
      <p>Your Fleet</p>
      <table id="player-grid" class="grid"></table>
    </div>
    <div>
      <p>Opponent's Ocean</p>
      <table id="opponent-grid" class="grid"></table>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDxwj4gjfwCGjgsWCpEHDyB8B03cpGs",
      authDomain: "it-s-a-game-c564d.firebaseapp.com",
      databaseURL: "https://it-s-a-game-c564d-default-rtdb.firebaseio.com/",
      projectId: "it-s-a-game-c564d",
      storageBucket: "it-s-a-game-c564d.appspot.com",
      messagingSenderId: "833723070612",
      appId: "1:833723070612:web:b09c51fc80fa964b9c81",
      measurementId: "G-R21LB7V3KH"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let gameRef, playerNum = null;
    const gridSize = 8;
    const ships = [4, 3, 3, 2];

    const roomId = new URLSearchParams(window.location.search).get('room') || Math.random().toString(36).substring(2, 8);
    if (!new URLSearchParams(window.location.search).get('room')) {
      history.replaceState(null, '', '?room=' + roomId);
    }
    gameRef = db.ref('games/' + roomId);

    function playSound(high) {
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioCtx.createOscillator();
      const gainNode = audioCtx.createGain();
      oscillator.connect(gainNode);
      gainNode.connect(audioCtx.destination);
      oscillator.frequency.value = high ? 800 : 200;
      oscillator.type = 'square';
      gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
      oscillator.start(audioCtx.currentTime);
      oscillator.stop(audioCtx.currentTime + 0.5);
    }

    function confettiBurst() {
      confetti({ particleCount: 150, spread: 60, origin: { y: 0.6 } });
    }

    new QRCode(document.getElementById("qr-code"), {
      text: window.location.href,
      width: 280,
      height: 280
    });

    function createGrid(tableId, clickable) {
      const table = document.getElementById(tableId);
      for (let i = 0; i < gridSize; i++) {
        const row = table.insertRow();
        for (let j = 0; j < gridSize; j++) {
          const cell = row.insertCell();
          cell.dataset.row = i;
          cell.dataset.col = j;
          if (clickable) cell.onclick = () => fire(i, j);
        }
      }
    }

    createGrid('player-grid', false);
    createGrid('opponent-grid', true);

    gameRef.child('players').transaction(current => {
      if (!current) current = { count: 0 };
      if (current.count >= 2) return;
      current.count++;
      return current;
    }, (error, committed, snapshot) => {
      if (error || !committed) {
        document.getElementById('status').textContent = 'Battle full ‚Äî start new!';
        return;
      }
      playerNum = snapshot.val().count;
      document.getElementById('status').textContent = `You are Player ${playerNum} ‚Äî Placing ships...`;
      placeShips();
    });

    function placeShips() {
      const myGrid = document.getElementById('player-grid');
      let placed = 0;
      const place = () => {
        if (placed >= ships.length) {
          gameRef.child(`ships/${playerNum}`).set(true);
          document.getElementById('status').textContent = 'Waiting for opponent...';
          checkReady();
          return;
        }
        const length = ships[placed];
        const horizontal = Math.random() < 0.5;
        let row = Math.floor(Math.random() * gridSize);
        let col = Math.floor(Math.random() * (gridSize - (horizontal ? length : 1)));
        // Basic no-overlap
        let valid = true;
        for (let i = 0; i < length; i++) {
          const r = horizontal ? row : row + i;
          const c = horizontal ? col + i : col;
          if (myGrid.rows[r].cells[c].className === 'ship') valid = false;
        }
        if (valid) {
          for (let i = 0; i < length; i++) {
            const r = horizontal ? row : row + i;
            const c = horizontal ? col + i : col;
            myGrid.rows[r].cells[c].className = 'ship';
          }
          placed++;
        }
        place();
      };
      place();
    }

    function checkReady() {
      gameRef.child('ships').on('value', snap => {
        if (snap.val() && snap.val()[1] && snap.val()[2]) {
          document.getElementById('status').textContent = playerNum === 1 ? 'Your turn! Fire!' : 'Opponent\'s turn...';
        }
      });
    }

    function fire(row, col) {
      const status = document.getElementById('status').textContent;
      if (!status.includes('Your turn')) return;
      const cell = document.getElementById('opponent-grid').rows[row].cells[col];
      if (cell.className) return; // already fired
      gameRef.child('shots').child(playerNum).push({row, col});
      playSound(true);
    }

    gameRef.child('shots').on('child_added', snap => {
      const shot = snap.val();
      const opponentShots = snap.key == (3 - playerNum);
      const grid = opponentShots ? document.getElementById('player-grid') : document.getElementById('opponent-grid');
      const cell = grid.rows[shot.row].cells[shot.col];
      if (opponentShots && cell.className === 'ship') {
        cell.className = 'hit';
        confettiBurst();
        playSound(false);
      } else {
        cell.className = 'miss';
      }
      // Simple win (count hits)
      const hits = Array.from(document.getElementById('player-grid').querySelectorAll('.hit')).length;
      if (hits >= 12) { // total ship cells
        document.getElementById('victory').style.display = 'block';
        confettiBurst();
      }
    });

  </script>
</body>
</html>